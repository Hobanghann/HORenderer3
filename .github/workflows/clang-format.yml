name: Clang Format Check

on:
  pull_request:
    branches: [ "main" ]

jobs:
  clang-format:
    name: clang-format
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install LLVM
      run: sudo apt-get update && sudo apt-get install -y clang-format

    - name: Run clang-format check
      id: format_check
      run: |
        echo "Running clang-format check..."

        # temp dir for formatted copies
        mkdir formatted

        # track failures
        error_count=0

        # scan target directories
        for file in $(find core platforms test -name "*.h" -o -name "*.cc"); do
          clang-format "$file" > formatted/"$(basename $file)"

          # compare original vs formatted
          if ! diff -q "$file" formatted/"$(basename $file)" >/dev/null; then
            echo ""
            echo "-------------------------------------"
            echo "  !! FORMAT MISMATCH: $file  !!"
            echo "-------------------------------------"
            diff -u "$file" formatted/"$(basename $file)"
            error_count=$((error_count+1))
          fi
        done

        echo ""
        echo "======== SUMMARY ========"
        if [ "$error_count" -eq 0 ]; then
          echo "[O] All files are properly formatted!"
        else
          echo "[X] $error_count file(s) need formatting."
          exit 1
        fi
